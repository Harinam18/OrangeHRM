# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

# Playwright CI - Allure 2 & Node 20 LTS
trigger:
- main

variables:
- group: 'Playwright-Secrets'

pool:
  vmImage: 'ubuntu-latest'

parameters:
- name: SCRIPT_KEY_VAL
  displayName: 'Select Script Key'
  type: string
  default: 'test_demo'
  values:
  - test_demo
  - test_demo_cr_hl
  - test_demo_fr_hl

steps:
# 1. Environment Setup
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Install Node.js (Stable LTS)'

- script: npm ci
  displayName: 'Install NPM Dependencies'

- script: npx playwright install --with-deps
  displayName: 'Install Playwright Browsers'

# 2. Run Tests
- script: |
    SECRET_KEY=$(SECRET_KEY) npm run ${{ parameters.SCRIPT_KEY_VAL }}
  displayName: 'Run Playwright Tests'
  continueOnError: true

# 3. Generate Allure 2 Report
# Using allure-commandline@2.x ensures version 2 is used instead of version 3
- script: |
    npx allure-commandline@2.29.0 generate allure-results --clean -o allure-report
  displayName: 'Generate Allure 2 Report'
  condition: succeededOrFailed()

# 4. Publish Allure Report
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: 'allure-report'
    artifact: 'allure-report'
    publishLocation: 'pipeline'
  displayName: 'Upload Allure Report'
  condition: succeededOrFailed()

# 5. Publish Playwright HTML Report
- task: PublishPipelineArtifact@1
  inputs:
    targetPath: 'playwright-report'
    artifact: 'playwright-html-report'
    publishLocation: 'pipeline'
  displayName: 'Upload Playwright HTML Report'
  condition: succeededOrFailed()
